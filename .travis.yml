language: python

env:
  global:
  - secure: lFak7oRDvrUpzXkYEEHzFnPQiJhqnKx01oINSQirg/4KXnENzHKe1laz9dxi1l/nR6GSLyKcjkvUNUEaF6DKY4/Sv0OnivWLba9L6BebRw3+SC3NfakZS9DbTZKFMFS4F7BM4nuOEeSDZxn7Uab5Gx7Z4O73IMOmxtBkdK+YUth3iZJ9VVXaJkdaPurPmoKRxlg+ehIirwX6TX/ewpq1soOPH+CZ3HMxd6RRpxj0hp12Vwevh6/uDFJH4c34RG6SIR1kGN/r/gcq4vrkdz35YjbdhU0K52JQc27D8P5yhhP/THDh/EZS6Kxk1ou10P0yfm3hWNpp2Z+aO4wuokLTbVcygLxA+nMRy6/GioOOKM6e0iINjnz/c/RlCgImQeaWgHuXTjib0/M5tG3OpltDA5eDRhpGcarS26fzq4Sb8j3cP5C5MFuhj4k+rE0EQlzQqjnLEo8Wzo1f4KnYFW4SIRrNbWHHyorRERIw5STMX0JB8Xkit84MF20w3NMRQs6qDF6AkJVY/OUFUgupeXXjQaALHcQG74u2F+4bq38uiC387kKMzbA/b5N51ZQkeJipPjo5tMpS+HXU54QEbJAKkmavQhuBgCqLSUlRRxGt2l6f+Ny9AT53/WIMB3V3y9nZlr8glhyItcKEVVBAWd7d252U+6ylymx30REkDpYCHeQ=
  - secure: D1mYdwt1Vz0CQbZJx/87AgmKIGV1qdaDPGABoSz5YchS8NrsFXkcty+WfytpiBfWqx/8mXaT0Y6MUcl888L6gRoGSVjRsWu7l5KhchiRTStW63frm1VkClvJIk5PTZvyH8S7XJNJ7TjqUhtlXk3BsMzFSqor456ssc7rpEI+WIdRmV4VwMuIXe35W/mJs3kXEJXTks2DkUSzjKYD8yOQA7mnsv2J/q0WaPDZGagAD7AMH89/Tveku970UvrbOIIBpzhA4TA04OW/d1pwotod/lZnTDp8N722yGaKeCO+ehw/IolMNLY/ivKWyZxfibP9TUaTOY1h0lwLj2VmixAvlSZdwmfFDO69mbB8tRQ3aNI6bX7gmWTnGcPh2aZ6cnHPrZ43C2jVAP0YOHZ7Rmc+U22wHyfgHsPmP36t2mJrN3AjB8vhcY10g9GuhRQ9AHX5A8Os5jET/7RoC0o03xBCXc+fTngkASyaSmavnIhZK3pUs66fH71GOE0IujtvhtvMJFOWn5mxEWUURfyZ+X/bRoG5+Q+sFgSH41humJEc+PDfj3AiyVtmYYve1QD1xeKW1UDAtCkhV0gZCeGrhloDRaWUDFh3svRSJdW6R8+QJf327NnLk2kBVLuKQTOUGgTeo+rLbk6EKc3kWBCxG8iYX6LBqDUIiQyxA9YwpjWYnAo=
  - secure: DrMltpsD/jH2f8ky5Dhq9a7p/WcriPV7EMv9wEjDCcfPvaWD6fag/GbbSQn3c1Jp5wtAzWs1DsrX/M54shhMPtNVoP+xgGNPK4NT9L43xIsmzZEncVBJZt62s2sN7panj4DGoS9i+LKJHGrpclJWSovrGKa+FsdJLw0t+Zm1W6ZtbC7ba6otAKtYzNohB8zbcPgM7QR+t6a2IDgVuMV6kN+k25/05Pi31b7vk/nxWM9ilJO3ImZBZopZlDAsN6PLMju20vBfz/Ax9wfHDPkfx5/VpEHLBcOcu/IvfHNO2oNziC70x7XkHkyuYvNm1QB2tNDhB1nI4JtHQZG0mP92d+oQh9JLQ5oy4HiFaj/hbzgFxpW7CeZC+KVCwOTdnGLqpz5EbxTspTcZ7ZdCKB4LrCsDi5KlgeFrdTogfwLT7X1l2T3JXsoADv0/gP9Uzh1i983yJvd+nSRujIuZzWxILRo5aFPg6LaUhVoZli4Hc/GOWM8sN0M29lTS2O8TIvHkwRWXyaIaME4tnI/DdFHi27Ef6UVTg6DYLRsni09gLLm+V3rkFOhRI4NsnX/AiuqDw080iRgYYKtA+/aYzN4Ar/dxNfV5zUgHTcnYYrR7zDmfTDVIQxHeaoPEjt6PoTqRiJLAlWRcJ4GhUGZYrgaNrtCsX8I4w0I0/fvN74I+nhQ=
  - Mongo_db=todo_db
  - secure: oBJNQuqRB+W9ZpT8WUDN1tNAG9htU9gjAGsd2L3UFjUzXC1xzrydbqxxTEQ2ViKV8Tm/o7mu9FpBspmH5OCbBMaMlQE3X78Z2xepUKxFWgdZrqFUkfKyueL9hyF1rtg5B+IGaoYee8VM0xk6ZCKvfZZ+84H8WMWAttLotfjK5vkChU0y0J4pA8AujrNc9mTAmZHQCZgu7sNxnkBCpZpM2J50/Y+4CCpACC/w3CWOKwydE/Lix9GXlILA6pt22Dod+1zkLCmYxPtQyXoXnzVmp/T+j2ywh+wG0PCOkayvnhKJ+LTiBYcZcdExti+Vetbu0MCMqv1hEBLFRXUNoG4YYR4uq1jhsgBmz8kSu78f76b97pPgjKZdpWuznrvmhyA2wqw+gJGfA1HhpIbNBLirHvcqM+agKdlj8UkVij5haLtgaSyWIl5MC/3vwBB87P+deGhST/Llp59HYVeI7oBCc/QDBa/MKFIFHcor17lKl0R2hE8evL3cO+n/sEKSmCY310XLYivWvtckQdWp+UIBEVsUo6f3iIVtdU7GXWeDC6tj+uB6YRDNDuyJc+fOr/c7Wv1BrBWucuwZKrZKE2ykH5KmK5VQ0MGCzQnZKBbGJLsTjvupanWOCH6ONorpR+veozv1xHVtiKSVzVA/8AY9B+FvWKuWFlZb7aOJPSQAKKA=
  - secure: QMxD4ybHkblPXnksBG6zF8za+b6JHVsFnfkDOIH9DI1jS7YdcESeEl2KD72V0kzzJT6tc1prdcxdKiQYXGb2VHJAeiX87CfDnB1p4xTNt9hjkjJd9eMXlqsMTEwtsrA06lRNC7adh+ip5nERtIcP8dOtmxXEbuApVQKKLuWfnu9gCsUvwOwhUEM0FprS+BK32NChQrKGX9Mn1NG0xNYHQaCCXdRi5mdJTDg4y8mCEM+2D82SeTlmpWpsiSaizqRZW+DQZMHQeU4z0D8uS5/PcW8lKVOQoGkzjmJ44K3EoeVbwO95df/ci5mNBDWJ3lGLr91Pz9/fBetQBHNqujA1+FivsBfzaAJfZLLlYxCVSjl7BWzF5fFNC73gud5XTYsZ2AB9EkkwSkeFnZ6HqyqAzDU/85Yuo7zBROpJbCUOR50MgZTtSlYP/wz78hixMSLhW1WQsPeMPlwNfl0MRTYnvTlMWFyxR6TkCnJVcmOKShKbFZqnurf+zi7RjumtNpT9cmmJR4ze9Q1EoEXYTpLOtjVC/AhYqh1uXxrMqbuVLosoVzIUdP1AsAU3nYeBKQee2gliS8DEaq9ZFgdloV9F4cRB7b03uEuR4fj+FXOPqD10Upmex92G7A5BmD7eJ6fygD0gEvGBkg/1NsbJ+Zt1+InKN9ggRnpJ6g2UMqhmlUs=
  - secure: CeL0dgP/0WwK4LQ8ULY7mvPU9hMj9D7HDgcUJ3lKHEzqX9BVLz56BGTxqYSUJw9MTcXJPbiUIdtVmfuvUwm1XENHBcUWDgU0GuOePU+Nh1U0I2NJ0WcUJ39pPG6d/rRd/4xY86WvwbPEb2v7psZtiqSeEV2bYW6+bxkRKvNab3eTGFdysjwoxoxjVE0+72cgBF9lzJmwlEgJu952UG4LawgvDGBjvXyTDqEc7YMO3dqjTHgI1/TqT/wjC/Zijl/BCHxqljMtIovYGX5AAj0lpXvOsqcR/6b6z0TuKBqPeveR0WBFY1Bob1owsQH16BOXAIGIZQPZZ6SlkOWvK0NtEtYDvmVT3Y2FJJVccyCUsKUE7dMWylkKsC8zpJo03Nt+S+qnETqXMsUCgW731oslMAHcXnmGffu7D94vi6hFD63EANco54HpHdWm7IXc/XjC+Rjvo9Z6ChRzw8kQVaEStrL30GpfwhXXUKb/1Ln+PlD6a8c46DjLuM/y/fJvdqQEXx5ki1HWjN5NjvS/ekfrzL9IW6WvObgC9p9Qu/0/eFpxNDpVMjXeQKrC/B8mTIHmPbwUqQo20U8xKjBiL23IhoVBdDR0HZhTtUFqr0merhsCsWX2l8fI43wth1JvPksuZ/0WcbOzw+xjD7nzF40AHpSS69PzWMo9aolxyxQt9Zs=
  - secure: e2c/3IfeJRr1NdX90NQJX83WP1LPPiC5KOEWCrrmRGTV96s8cxxdAQh9uj7lEfDSNlulQhU46AJS0MwCFXJah4h3rpY709QZTTx1P5P0aOM4hvsqE9hs8sTvBEyWaZ845Qfu7J3pxliRoI3OdTPbK3fOfROzY5iMf0KUOlQFlW2sWzfTWuyFe55yVsadwzZpIEP+73EruHSks3tHfjQAKiw/Ux4H8klDNYfrZQKL5zz/SsIylh4C+T5TL9sGMEDezC62DA0CZjIqEUGiaKISkWIsTvDFrRZK/1RBpRkzUPuHbLnzJVLBCcHkR8sNswZCeJO4+APeoyAN2xxIlpBh0L4wo5Ajv/++0WrUGqUIlI4Dw7JyodS6Lyr3x2yw5ciYYKFCw7pkdTFzfRoO0BQNe0Msh+73bHEom1oHoGt7VAgUatZN880z++i4x1cXWnRmlSwtOLH9RtHEvjo/YBRB4z+W4ZQkj2m76G+mRj7oSsH/b957unqNKgsWsHLEvB8WJo8k3UJBVlIhHggYQyPYcCSaFMpLXNiy4dqUTM/Mo1HxpfdtBvsa5QMZ370yqjgk9MU/P3ej0hJtjHV3hwl2YTq1GL0aJuHOfv9pypYYN2wK8o2uSGKo0Bj06BU6p/ECdOHMRR3QaPyCho6HzAVv4z+TLPPB9ND9ZZVcuuukesY=
  - secure: BoI7EzVy68Avk4wjcKpkHyBeqmt/VAghDGDM7EiTE3egfNz+pdvP+5f4L00+Ljx8TDavIERt99dg8vHrORFKt3QemjG0R4ombaJZkZeSlB3X+XXtDXDPr/02/eRPRuxrBrRnylK941kNE+jLH5LXr5oeUpXecFB0TL9vnmjiMHcO4Xe3Hr3UFXBl/jwrqeJMqys5L6hjft447isNNYmT9YPz+MOjkGa7ItPLMsbdVhzVh6oPdOFUai+azva7twGm/Y42d2LF0Hpmj3az+zw7UWh50PKxjxBrElaIkt+AGMqrYoXn58/3JJI1/c1Dq3XguR1xiFjsedqwcN65BrykKMaE9974/tYNZIdrpyXPoM1GhDzWpYVCvLEKfL9bJdaCbdRTSLSBF8YmccizEAqB4X+WaCUVfDIH/PNCMc2o5CfV2jZCUZPAFBs8pHNqbTcfEQGMhJaGnYGvTxTKzbiPZqImnGWgcnNRT9FB77JhM6yMOeFwPcwV6/7qwf0SVlPY2QIHS9lb5nqH2lT2x0Qv7eZpMHb3NJtMV+JxkSF+Lv3W8/kGxpljuixm6DJOfWV+ZCkOvjLpPryRYhG2Z7fMiVlhUxhHMQgnwdnjZ9WQ7YGLlO49ZAHMIlRaJdacN1JNj4Ka1vmreQ5kKSQK07UAMmJfZm03oZFikBo+SgAhJRQ=
  - TF_VERSION=0.14.7
  
  stages:
  - test
  - install
  - before_deploy
  - deploy

jobs:
  include:
  - stage: test
    script:
    - echo $DockerPassword | docker login --username joefish29 --password-stdin
    - docker build --target test --tag my-test-image .
    - docker run --env-file .env.test my-test-image test_client.py
    - docker run --env-file .env.test my-test-image test_items.py
    - docker run -e Mongo_Url my-test-image test_system.py

  - stage: install
    install:
    - wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
    - unzip terraform_"$TF_VERSION"_linux_amd64.zip
    - sudo mv terraform /usr/local/bin/
    - rm terraform_"$TF_VERSION"_linux_amd64.zip
    - terraform init
    - terraform plan

  - stage: before_deploy
    before_deploy:
    - echo $DockerPassword | docker login --username joefish29 --password-stdin
    - docker build --target production --tag joefish29/todo-app:latest .
    - docker push joefish29/todo-app:latest
    - terraform apply -auto-approve
    on:
      branch: master

  - stage: deploy
    deploy:
      - curl -dh -X post travis_webhook
    on:
      branch: master
